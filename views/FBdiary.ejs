<!DOCTYPE html>
<html lang="ko">
<head>
<title>게임</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0">
<link href="/css/main.css" rel="stylesheet" type="text/css"/>
<script src="/js/async.js"></script>
<script src="/js/step.js"></script>
<script src="http://underscorejs.org/underscore-min.js"></script>
<script type="text/javascript" src="http://connect.facebook.net/en_US/all.js"></script>
<script src="http://code.jquery.com/jquery-1.8.3.min.js"></script>
<script src="http://ricostacruz.com/jquery.transit/jquery.transit.min.js"></script>
<script src="/js/FBDiary/facebook_contents_loader.js"></script>
<script src="/js/FBDiary/facebook_clip.js"></script>
<script>

    function initLocalStorage() {
        if (typeof(Storage) !== "undefined") {
        }
        else {
            alert("브라우져가 웹스토리지를 지원하지 않습니다. 스크랩이 사용 불가능하고 로딩시간이 길어질 수 있습니다.");
        }
    }
    function isStorageEnabled() {
        return typeof(Storage) !== "undefined";
    }


    function searchPost(keyword) {
        $.each($(".date-container"), function (i, v) {
            var content = $(v).html();
            if (content.indexOf(keyword) != -1) {
                console.log(content);
                $(v).clearQueue().slideDown();
            } else {
                $(v).clearQueue().slideUp();
            }
        });
    }

    function initFacebook(callback) {
        var debug_app = "358262920960112";
        var release_app = "333864290041286";
        FB.init({ "appId": debug_app,
            "status": false,
            "cookie": true,
            "xfbml": true,
            "oauth": true});
        function startFacebookLogin(success, failure) {
            FB.login(function (response) {
                if (response.authResponse) {
                    success(response);
                } else {
                    failure(response);
                }
            }, {"scope": 'email,user_likes,read_stream'});
        }

        function facebookLoginFailureCallback() {
            alert("페이스북 로그인이 취소되었습니다. 다이어리 사용이 불가능합니다.");
        }

        FB.getLoginStatus(function (response) {
            if (response.status === 'connected') {
                callback(response);
            } else if (response.status === 'not_authorized') {
                startFacebookLogin(callback, facebookLoginFailureCallback);
            } else {
                startFacebookLogin(callback, facebookLoginFailureCallback);
            }
        });
    }

    function showDateIn(date) {
        $("#showDayButton").html((date.getMonth() + 1) + "/" + date.getDate());
        $(".date-container").clearQueue().hide();
        for (var i = 2000; i < date.getFullYear(); i++) {
            $(".date-container[date='" + i + "/" + (date.getMonth() + 1) + "/" + date.getDate() + "']").clearQueue().fadeIn();
        }
    }

    var currentShowingDate = new Date();
    function showPreviousDayContent() {
        currentShowingDate.setDate(currentShowingDate.getDate() - 1);
        showDateIn(currentShowingDate);
    }
    function showTodayContent() {
        currentShowingDate = new Date();
        showDateIn(currentShowingDate);
    }
    function showNextDayContent() {
        currentShowingDate.setDate(currentShowingDate.getDate() + 1);
        showDateIn(currentShowingDate);
    }

    var calendarMap = {};

    $(document).ready(function () {
        $("#search_input").change(function () {
            searchPost($(this).val());
        });

        initFacebook(function () {

            var facebookContentsLoader = new FacebookContentsLoader();

            $(".Loading").fadeOut();

            function createPostDiv(v){
                $(".site-container").append(
                                "<div class='Status'>" +
                                        v.message +
                                        "</div>"
                        ).children().last().click(function(){
                            alert(JSON.stringify(v));
                            $(this).clone().appendTo($(".left-pad"));
                        });
            }

            function loadingFBPostLoop(response){
                console.log(response);
                _.each(response.data, createPostDiv);
                if(response.data.length > 0 && response.paging.next){
                    $.getJSON(response.paging.next,loadingFBPostLoop);
                }
                else {
                    console.log("loading finished");
                    alert("글 로딩이 끝났습니다");
                }
            }


                FB.api("me/posts",{limit:200},loadingFBPostLoop);

            /*
            Step(function loadStuff() {
                        facebookContentsLoader.getAllStatuses(this.parallel());
                        facebookContentsLoader.getAllPhotos(this.parallel());
                        facebookContentsLoader.getAllLinks(this.parallel());
                    }, function showStuff(error, statuses, photos, links) {
                        if (error) {
                            console.err(error);
                        } else {
                            var contents = _.chain(_.union(statuses,photos,links))
                                            .sortBy(function(a){ return -a.getCreatedTime().getTime(); })
                                            .value();

                            calendarMap = _.groupBy(contents, function(v){
                                var x = v.getCreatedTime();
                                return x.getFullYear() + "/" + (x.getMonth() + 1) + "/" + x.getDate();
                            });


                            for (var i in calendarMap) {
                                var title = i;

                                $(".site-container").append("<div class='date-container' date = '" + title + "'><p class='title'>" + title + "</p></div>");

                                var contents = calendarMap[i];
                                contents.forEach(function (v, i) {
                                    if (v instanceof Photo) {
                                        $(".date-container[date='" + title + "']").append(
                                            "<div class='Photo'>" +
                                                "<a href = '" + v.src_big + "'>" +
                                                    "<img src='" + v.src + "' />" +
                                                "</a>" +
                                                "<p class='caption'>" + (v.caption ? v.caption : "") + "</p>" +
                                            "</div>"
                                        ).children().last().click(function(){
                                            console.log(v);
                                        });
                                    }
                                    else if (v instanceof Status) {
                                        $(".date-container[date='" + title + "']").append(
                                                "<div class='Status'>" +
                                                    v.message +
                                                "</div>"
                                        ).children().last().click(function(){
                                            $(this).clone().appendTo($(".left-pad"));
                                        });
                                    }
                                    else if (v instanceof Link) {
                                        $(".date-container[date='" + title + "']").append(
                                                "<div class='Link'>" +
                                                        "<p>" + v.title + "</p>" +
                                                        "<p>" + v.summary + "</p>" +
                                                        "<p>" + v.owner_comment + "</p>" +
                                                        "<p>" + v.url + "</p>" +
                                                        (v.image_urls ? ("<a href = '" + v.url + "'>" +
                                                                "<img src='" + v.image_urls[0] + "'/>" +
                                                                "</a>") : ("")) +
                                                        "</div>"
                                        ).children().last().click(function(){
                                                    console.log(v);
                                                });
                                    }
                                });
                            }
                        }

                        $(".Loading").fadeOut();
                    }
            );
            */
        });
    });
</script>
<style>
    html, body {
        width: 100%;
        height: 100%;
        overflow: hidden;
    }

    * {
        font-size: 1em;
        letter-spacing: -1px;
        font-family: NanumGothic, "Apple SD Gothic Neo", "Malgun Gothic", AppleGothic, Dotum, sans-serif;
        margin: 0px;
        padding: 0px;
    }

    .site{
        width:100%;
        height:100%;
    }

    .site .left-pad{
        float:left;
        width:30%;
        height:100%;
        background-color:#df8505;
    }
    .site .right-pad{
        float:right;
        width:70%;
        height:100%;
        background-color:#2f96b4;
        overflow-y:scroll;
    }

    .site-container {
        width: 100%;
        height: 100%;
        overflow: scroll;
    }

    .date-container {
        border-radius: 10px;
        background-color: rgb(142, 194, 190);
        width: 500px;
        height: auto;
        margin-bottom: 10px;
    }

    .date-container .title {
        text-align: center;
        font-family: "맑은 고딕";
        font-size: 40px;
    }

    .Photo {
        width: 100%;
        height: auto;
        background-color: rgba(0, 0, 0, 0.28);
        margin-bottom: 8px;
        border-radius: 5px;
    }

    .Photo img {
    }

    .Photo .caption {
    }

    .Status {
        width: 100%;
        height: auto;
        background-color: rgba(0, 0, 0, 0.28);
        margin-bottom: 8px;
        border-radius: 5px;
    }

    .Link {
        width: 100%;
        height: auto;
        background-color: rgba(0, 0, 0, 0.28);
        margin-bottom: 8px;
        border-radius: 5px;
    }

    .Loading {
        width: 100%;
        height: 100%;
        position: absolute;
        left: 0px;
        top: 0px;
        background-color: black;
        color: white;
    }
</style>
</head>
<body>
<div class="site">
    <div class="left-pad">

    </div>
    <div class="right-pad">
        <header>
            <button onclick="showPreviousDayContent();"><<</button>
            <button id="showDayButton" onclick="showTodayContent();">오늘꺼 보기</button>
            <button onclick="showNextDayContent();">>></button>
            <input type="text" id="search_input"/>
        </header>
        <div class="site-container">

        </div>
        <div class="Loading">Loading..</div>
    </div>
</div>
</body>
</html>